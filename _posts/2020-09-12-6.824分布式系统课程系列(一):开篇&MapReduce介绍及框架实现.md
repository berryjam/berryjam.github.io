---
layout: post
title: 6.824分布式系统课程系列(一):开篇&MapReduce介绍及框架实现
date: 2020-09-12 23:32:00.000000000 +09:00
tags: 分布式系统 MapReduce 6.824
---


# 开篇&MapReduce介绍及框架实现

**Note. 现在分布式已经成为后台开发者的必备技能，而Golang在并发方面引入了协程的方式，相对于其他语言极大地提高了并发处理能力。综合这些因素，麻省理工大学开设了用Golang实现分布式系统的课程，即6.824。在学习这门课程之前，最好对Golang有一定使用，不然在实现课程实验中会有较大的阻碍。而学习这门课程我们将涉及到存储、通信、计算等三方面的应用基础架构，目的是隐藏分布式复杂性的抽象。对于面试、工作都是非常有帮助的，希望接下来的分享能与大家探索分布式系统遇到的难题和乐趣，并一同成长。**

- [1. 6.824课程开篇内容](https://github.com/berryjam/berryjam.github.io/blob/master/_posts/2020-09-12-6.824%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E7%B3%BB%E5%88%97(%E4%B8%80):%E5%BC%80%E7%AF%87&MapReduce%E4%BB%8B%E7%BB%8D%E5%8F%8A%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0.md#1-6824%E8%AF%BE%E7%A8%8B%E5%BC%80%E7%AF%87%E5%86%85%E5%AE%B9)

- [2. MapReduce介绍回顾](https://github.com/berryjam/berryjam.github.io/blob/master/_posts/2020-09-12-6.824%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E7%B3%BB%E5%88%97(%E4%B8%80):%E5%BC%80%E7%AF%87&MapReduce%E4%BB%8B%E7%BB%8D%E5%8F%8A%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0.md#2-mapreduce%E4%BB%8B%E7%BB%8D%E5%9B%9E%E9%A1%BE)

- [3. MapReduce课程框架介绍](https://github.com/berryjam/berryjam.github.io/blob/master/_posts/2020-09-12-6.824%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E7%B3%BB%E5%88%97(%E4%B8%80):%E5%BC%80%E7%AF%87&MapReduce%E4%BB%8B%E7%BB%8D%E5%8F%8A%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0.md#3-mapreduce%E8%AF%BE%E7%A8%8B%E6%A1%86%E6%9E%B6%E4%BB%8B%E7%BB%8D)

- [4. MapReduce框架逐步实现](https://github.com/berryjam/berryjam.github.io/blob/master/_posts/2020-09-12-6.824%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E7%B3%BB%E5%88%97(%E4%B8%80):%E5%BC%80%E7%AF%87&MapReduce%E4%BB%8B%E7%BB%8D%E5%8F%8A%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0.md#4-mapreduce%E6%A1%86%E6%9E%B6%E9%80%90%E6%AD%A5%E5%AE%9E%E7%8E%B0)

- [5. 参考资料](https://github.com/berryjam/berryjam.github.io/blob/master/_posts/2020-09-12-6.824%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E8%AF%BE%E7%A8%8B%E7%B3%BB%E5%88%97(%E4%B8%80):%E5%BC%80%E7%AF%87&MapReduce%E4%BB%8B%E7%BB%8D%E5%8F%8A%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0.md#5-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99)

## 1. 6.824课程开篇内容

下面简单罗列这个课程开篇的主要内容，包含课程目标、课程构成、实验介绍及主题。

### 为什么学习这门课程？

- 有趣，会遇到很多难题，但能提供非常强大的解决方案
- 被很多实际系统使用的理论知识，由大型网站的兴起驱动
- 活跃的研究领域，至今尚未解决的重要问题
- 动手操作，将在接下来的实验中构建真实的分布式系统

### 课程实验

- 实验1: MapReduce
- 实验2: 使用Raft共识算法以实现容错
- 实验3: 实现具容错key/value存储系统
- 实验4: 实现带有分片能力的key/value存储系统

### 课程主题

这是一门有关应用程序基础结构的课程：
* 存储
* 网络通信
* 计算

主题：动手实现，“纸上得来终觉浅，绝知此事要躬行”。

&nbsp;包括但不限于：RPC、多线程、并发控制、上面提到的4个实验。

主题：性能
&nbsp;&nbsp;目标：可扩展的吞吐量

&nbsp;&nbsp;&nbsp;Nx服务器->通过并行CPU，磁盘，网络达到Nx总吞吐量

&nbsp;&nbsp;当N增长时，扩展会变得越来越难：

&nbsp;&nbsp;&nbsp;负载不均衡、延迟取决于N机器里最慢的那一台

&nbsp;&nbsp;&nbsp;不可并行化的代码：初始化及交互

&nbsp;&nbsp;某些性能问题不能通过简单的扩展来解决

&nbsp;&nbsp;&nbsp;e.g 单个用户请求的快速响应时间

&nbsp;&nbsp;&nbsp;e.g 所有用户都想要更新相同的数据

&nbsp;&nbsp;&nbsp;通常需要更好的设计而不仅仅是添加更多的机器

主题：容错性

&nbsp;&nbsp;比如1000台服务器，组成的大网络 -> 这里面总会存在一些异常，比如机器挂掉或者网络出现分区

&nbsp;&nbsp;我们在实验中为用户隐藏这些错误的处理细节。

&nbsp;&nbsp;通常系统需要：

&nbsp;&nbsp;&nbsp;可用性 -- 应用能够在发生错误的情况下继续提供服务

&nbsp;&nbsp;&nbsp;可恢复性 -- 应用能够在错误恢复的时候马上恢复正常状态

&nbsp;&nbsp;&nbsp;整体思路：通过多份复制的服务器实现，如果有一台服务器挂掉，那么能够使用其他服务来处理这台服务器接受的请求

主题：一致性

&nbsp;通用基础结构需要明确定义的行为。

&nbsp;&nbsp;例如："Get(k)会拿到Put(k,v)之后的最新值"

&nbsp;实现良好的行为很难！

&nbsp;&nbsp;"Replica"服务器很难保持一致。

&nbsp;&nbsp;客户端可能会在多步骤更新中崩溃。

&nbsp;&nbsp;服务端可能在执行之后但回复客户端之前崩溃。

&nbsp;&nbsp;网络分区可能会使存活的服务器看起来像宕机一样，有“脑裂”风险。

&nbsp;一致性和性能是矛盾的存在

&nbsp;&nbsp;强一致性需要节点间通信

&nbsp;&nbsp;许多设计仅提供弱一致性，以此来提高性能


下面以MapReduce作为第一个分布式系统案例来探讨可用性和一致性及分区容忍性之间的关系。


## 2. MapReduce介绍回顾

MapReduce的详细介绍可参考之前的文章[MapReduce:大数据并行计算框架](https://berryjam.github.io/2018/05/MapReduce-%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97%E6%A1%86%E6%9E%B6/)，本篇主要介绍MR框架的实验和代码细节，就不再赘述，核心围绕着MapReduce框架执行的整体流程来叙述。

<div align="center">
<img src="https://raw.githubusercontent.com/berryjam/berryjam.github.io/master/image/MRExecution.png" height="70%" width="70%">	
</div>

<p align="center">
  <b>图 1 MapReduce框架执行流程</b><br>
</p>

## 3. MapReduce课程框架介绍

这是一个构建MapReduce系统的实验[[1]](https://pdos.csail.mit.edu/6.824/labs/lab-mr.html)，我们将实现两个程序（以单个进程形式运行）：

**worker程序**：调用应用程序定义的Map和Reduce函数，并通过读写文件方式来处理两个函数的输入、输出。

**master程序**：而master进程则负责将任务指派给worker，并处理执行过程中失败的worker。

可以看出MapReduce是一个典型的主从架构，接下来的实现如论文[[2]](http://static.googleusercontent.com/media/research.google.com/zh-CN//archive/mapreduce-osdi04.pdf)所述。

### 环境准备

获取代码

```
$ git clone git://g.csail.mit.edu/6.824-golabs-2020 6.824
$ cd 6.824
$ ls
Makefile src
```

最开始实验里面已经包含了一个简单顺序执行的mapreduce实现，代码在`src/main/mrsequential.go`。这个程序以一个进程的方式运行，以顺序方式分别调用map和reduce函数，这里reduce函数一定是在执行完所有map函数之后才开始执行的。

### 实验任务



## 4. MapReduce框架逐步实现

master代码详见：https://github.com/berryjam/6.824-2020/blob/master/src/mr/master.go

worker代码详见：https://github.com/berryjam/6.824-2020/blob/master/src/mr/worker.go

运行测试脚本，test-mr.sh，如果都通过的话会在最后输出*PASSED ALL TESTS*，整个运行过程输出大致如下：
```
$ sh test-mr.sh
os.Args[2:] [../pg-being_ernest.txt ../pg-dorian_gray.txt ../pg-frankenstein.txt ../pg-grimm.txt ../pg-huckleberry_finn.txt ../pg-metamorphosis.txt ../pg-sherlock_holmes.txt ../pg-tom_sawyer.txt]
filename:../pg-being_ernest.txt
filename:../pg-dorian_gray.txt
filename:../pg-frankenstein.txt
filename:../pg-grimm.txt
filename:../pg-huckleberry_finn.txt
filename:../pg-metamorphosis.txt
filename:../pg-sherlock_holmes.txt
filename:../pg-tom_sawyer.txt
*** Starting wc test.
2020/09/14 15:55:01 rpc.Register: method "Done" has 1 input parameters; needs exactly three
--- wc test: PASS
os.Args[2:] [../pg-being_ernest.txt ../pg-dorian_gray.txt ../pg-frankenstein.txt ../pg-grimm.txt ../pg-huckleberry_finn.txt ../pg-metamorphosis.txt ../pg-sherlock_holmes.txt ../pg-tom_sawyer.txt]
filename:../pg-being_ernest.txt
filename:../pg-dorian_gray.txt
filename:../pg-frankenstein.txt
filename:../pg-grimm.txt
filename:../pg-huckleberry_finn.txt
filename:../pg-metamorphosis.txt
filename:../pg-sherlock_holmes.txt
filename:../pg-tom_sawyer.txt
*** Starting indexer test.
2020/09/14 15:55:14 rpc.Register: method "Done" has 1 input parameters; needs exactly three
--- indexer test: PASS
*** Starting map parallelism test.
2020/09/14 15:55:25 rpc.Register: method "Done" has 1 input parameters; needs exactly three
--- map parallelism test: PASS
*** Starting reduce parallelism test.
2020/09/14 15:55:40 rpc.Register: method "Done" has 1 input parameters; needs exactly three
--- reduce parallelism test: PASS
os.Args[2:] [../pg-being_ernest.txt ../pg-dorian_gray.txt ../pg-frankenstein.txt ../pg-grimm.txt ../pg-huckleberry_finn.txt ../pg-metamorphosis.txt ../pg-sherlock_holmes.txt ../pg-tom_sawyer.txt]
filename:../pg-being_ernest.txt
filename:../pg-dorian_gray.txt
filename:../pg-frankenstein.txt
filename:../pg-grimm.txt
filename:../pg-huckleberry_finn.txt
filename:../pg-metamorphosis.txt
filename:../pg-sherlock_holmes.txt
filename:../pg-tom_sawyer.txt
*** Starting crash test.
2020/09/14 15:55:57 rpc.Register: method "Done" has 1 input parameters; needs exactly three
--- crash test: PASS
*** PASSED ALL TESTS
```

这个实验是单机通过rpc方式来模拟分布式环境，实际跨节点的分布式环境会更复杂。单机环境的输入都来源同一节点上的文件系统，而分布式系统下输入及输出需要依赖分布式文件系统。而且本节实现只是一个比较简单的map reduce实现，比如master对于并发控制粒度比较粗，性能上还有很多优化的空间，不过这个实验本身还是很有趣，会遇到很多实际问题需要我们去解决让我们积累更多经验。生产级的分布式并行计算框架里面会涉及到更多的细节和优化，可谓任重道远。

## 5. 参考资料

[[1]](https://pdos.csail.mit.edu/6.824/labs/lab-mr.html) 6.824 Lab 1: MapReduce

[[2]](http://static.googleusercontent.com/media/research.google.com/zh-CN//archive/mapreduce-osdi04.pdf) MapReduce: Simplified Data Processing on Large Clusters
